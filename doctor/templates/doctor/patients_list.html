{% if patients %}
  <!-- ACCEPTED PATIENTS -->
  <div class="patient-section accepted">
    <h5 class="section-title text-success"><i class="bi bi-check-circle"></i> Accepted Patients</h5>
    <button class="toggle-btn" onclick="invisible_accepted()">
      <i class="bi bi-chevron-down" style="color:gray"></i>
    </button>  
    <div class="patients-grid">
      {% for patient in patients %}
        {% if patient.status == 'accepted' %}
          <div class="patient-card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="card-title mb-0"><i class="bi bi-person-circle"></i> {{ patient.name }}</h6>
              <button class="btn btn-sm collapse-btn" type="button" data-bs-toggle="collapse" data-bs-target="#accepted-{{ patient.patient_id }}" aria-expanded="true" aria-controls="accepted-{{ patient.patient_id }}">
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>

            <div id="accepted-{{ patient.patient_id }}" class="collapse show accepted">
              <div class="card-body">
                <p class="mb-1"><i class="bi bi-card-text"></i> <strong>ID:</strong> {{ patient.patient_id }}</p>
                <p class="mb-1"><i class="bi bi-calendar3"></i> <strong>Age:</strong> {{ patient.age }}</p>
                {% if patient.phone %}
                  <p class="mb-1"><i class="bi bi-telephone"></i> <strong>Phone:</strong> {{ patient.phone }}</p>
                {% endif %}
                <p class="text-muted small mb-0"><i class="bi bi-file-text"></i> <strong>Reason:</strong> {{ patient.reason }}</p>
              </div>

              <div class="card-footer d-flex justify-content-between">
                <a class="btn btn-sm btn-primary" href="{% url 'doctor:patient_profile' patient.patient_id %}">
                  <i class="bi bi-box-arrow-up-right"></i> Profile
                </a>
                <a class="btn btn-sm status-btn accepted">
                  <i class="bi bi-check2"></i> Accepted
                </a>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <hr class="section-divider">

  <!-- WAITING PATIENTS -->
  <div class="patient-section waiting-out">
    <h5 class="section-title text-warning"><i class="bi bi-hourglass-split"></i> Waiting Patients</h5>
    <button class="toggle-btn" onclick="invisible_waitingout()">
      <i class="bi bi-chevron-down" style="color:gray"></i>
    </button>  
    <div class="patients-grid">
      {% for patient in patients %}
        {% if patient.status == 'waiting_out' %}
          <div class="patient-card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="card-title mb-0"><i class="bi bi-person-circle"></i> {{ patient.name }}</h6>
              <button class="btn btn-sm collapse-btn" type="button" data-bs-toggle="collapse" data-bs-target="#waiting-{{ patient.patient_id }}" aria-expanded="true" aria-controls="waiting-{{ patient.patient_id }}">
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>

            <div id="waiting-{{ patient.patient_id }}" class="collapse show waiting-out">
              <div class="card-body">
                <p class="mb-1"><i class="bi bi-card-text"></i> <strong>ID:</strong> {{ patient.patient_id }}</p>
                <p class="mb-1"><i class="bi bi-calendar3"></i> <strong>Age:</strong> {{ patient.age }}</p>
                {% if patient.phone %}
                  <p class="mb-1"><i class="bi bi-telephone"></i> <strong>Phone:</strong> {{ patient.phone }}</p>
                {% endif %}
                <p class="text-muted small mb-0"><i class="bi bi-file-text"></i> <strong>Reason:</strong> {{ patient.reason }}</p>
              </div>

              <div class="card-footer d-flex justify-content-between">
                <a class="btn btn-sm btn-primary" href="{% url 'doctor:patient_profile' patient.patient_id %}">
                  <i class="bi bi-box-arrow-up-right"></i> Profile
                </a>
                <a class="btn btn-sm status-btn waiting">
                  <i class="bi bi-hourglass-split"></i> Waiting
                </a>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <hr class="section-divider">

  <!-- DONE PATIENTS -->
  <div class="patient-section done">
    <h5 class="section-title text-secondary"><i class="bi bi-clipboard-check"></i> Done Patients</h5>
    <button class="toggle-btn" onclick="invisible_done()">
      <i class="bi bi-chevron-down" style="color:gray"></i>
    </button>  
    <div class="patients-grid">
      {% for patient in patients %}
        {% if patient.status == 'done' %}
          <div class="patient-card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="card-title mb-0"><i class="bi bi-person-circle"></i> {{ patient.name }}</h6>
              <button class="btn btn-sm collapse-btn" type="button" data-bs-toggle="collapse" data-bs-target="#done-{{ patient.patient_id }}" aria-expanded="true" aria-controls="done-{{ patient.patient_id }}">
                <i class="bi bi-chevron-down"></i>
              </button>
            </div>

            <div id="done-{{ patient.patient_id }}" class="collapse show done">
              <div class="card-body">
                <p class="mb-1"><i class="bi bi-card-text"></i> <strong>ID:</strong> {{ patient.patient_id }}</p>
                <p class="mb-1"><i class="bi bi-calendar3"></i> <strong>Age:</strong> {{ patient.age }}</p>
                {% if patient.phone %}
                  <p class="mb-1"><i class="bi bi-telephone"></i> <strong>Phone:</strong> {{ patient.phone }}</p>
                {% endif %}
                <p class="text-muted small mb-0"><i class="bi bi-file-text"></i> <strong>Reason:</strong> {{ patient.reason }}</p>
              </div>

              <div class="card-footer d-flex justify-content-between">
                <a class="btn btn-sm btn-primary" href="{% url 'doctor:patient_profile' patient.patient_id %}">
                  <i class="bi bi-box-arrow-up-right"></i> Profile
                </a>
                <a class="btn btn-sm status-btn done">
                  <i class="bi bi-clipboard-check"></i> Done
                </a>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

{% else %}
  <div class="empty-state"><i class="bi bi-info-circle"></i> No patients found.</div>
{% endif %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
function toggleSection(sectionClass, storageKey) {
    const section = document.querySelector(`.patient-section.${sectionClass}`);
    if (!section) return;

    const cards = Array.from(section.querySelectorAll('.patient-card'));
    const toggleBtnIcon = section.querySelector('.toggle-btn i');

    const isHidden = localStorage.getItem(storageKey) === 'true';
    const newHidden = !isHidden;

    // Show/hide cards
    cards.forEach(c => c.style.display = newHidden ? 'none' : 'flex');

    // Swap chevron
    if (toggleBtnIcon) {
        toggleBtnIcon.classList.toggle('bi-chevron-up', newHidden);
        toggleBtnIcon.classList.toggle('bi-chevron-down', !newHidden);
    }

    localStorage.setItem(storageKey, newHidden);
}

// Section toggle functions
function invisible_accepted() { toggleSection('accepted', 'invis_accepted'); }
function invisible_waitingout() { toggleSection('waiting-out', 'invis_waitingout'); }
function invisible_done() { toggleSection('done', 'invis_done'); }

// Restore state on page load
document.addEventListener('DOMContentLoaded', function() {
    ['accepted', 'waiting-out', 'done'].forEach(cls => {
        const storageKey = 'invis_' + cls.replace('-', '');
        if (localStorage.getItem(storageKey) === 'true') {
            toggleSection(cls, storageKey);
        }
    });
});
</script>

<style>
.section-title { margin-bottom: 10px; font-weight: 600; }
.section-divider { border: none; border-top: 2px solid #e6e6e6; margin: 30px 0; }

.patients-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  align-items: start;
}

.patient-card {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  min-height: 180px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  transition: transform .15s ease, box-shadow .15s ease;
  overflow: hidden;
}
.patient-card:hover { transform: translateY(-4px); box-shadow: 0 8px 22px rgba(0,0,0,0.12); }

.card-header { padding: 12px; background: #f9f9f9; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
.card-body { padding: 12px; }
.card-title { font-weight: 600; font-size: 0.95rem; color: #2c3e50; }

.card-footer { padding: 8px 12px; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; background: #fff; }

.btn-primary { background: #3498db; border: none; font-size: 0.8rem; padding: 6px 8px; }
.status-btn { border: none; font-size: 0.8rem; padding: 5px 8px; border-radius: 6px; text-decoration: none; cursor: default; color: white; transition: opacity 0.2s ease; }
.status-btn.accepted { background-color: #27ae60; }
.status-btn.waiting { background-color: #e74c3c; }
.status-btn.done { background-color: #bdc3c7; color: #333; }

.collapse-btn { border: none; background: none; color: #555; font-size: 1rem; cursor: pointer; transition: transform 0.2s ease; }
.collapse-btn:focus { outline: none; }
.collapse-btn[aria-expanded="true"] i { transform: rotate(180deg); }

.empty-state { text-align: center; color: #777; font-size: 1.05rem; padding: 20px; border: 2px dashed #ddd; border-radius: 12px; background: #fff; margin-top: 20px; }

.toggle-btn {
  width: 13px;
  height: 13px;
  border-radius: 50%;
    border:none;
  background-color: #fff;
  color: #fff;
  font-size: 0.7rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  margin-bottom: 10px;
  transition: transform 0.2s ease, background-color 0.2s ease;
}
.toggle-btn:hover {
  background-color: #fff;
  transform: scale(1.1);


}

@media (max-width: 1100px) { .patients-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 600px) { .patients-grid { grid-template-columns: 1fr; } }
</style>
