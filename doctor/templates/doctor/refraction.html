<!-- Refraction Section -->
<div id="refraction" class="section">
  <h3>Refraction</h3>

  <div id="refraction-forms">
    <!-- First Form -->
    <div class="refraction-card">
      <div class="card-header">
        <span class="card-title">Refraction Form #1</span>
        <div class="card-actions">
          <button type="button" class="toggle-card">▼</button>
          <button type="button" class="add-form">➕</button>
          <button type="button" class="remove-form">➖</button>
        </div>
      </div>

      <div class="card-body">
        <form method="POST" 
              action="{% url 'doctor:submit_refraction' patient.patient_id %}" 
              class="refraction-form">
          {% csrf_token %}

          <!-- Subject -->
          <div class="form-row">
            <label>Subject:</label>
            <input type="text" name="subject" required>
          </div>

          <!-- OD -->
          <div class="form-row">
            <label>OD:</label>
            <input type="text" name="od" value="       /        ×   " class="od-input">
            <input type="text" name="odcl" class="odcl" style="display:none">
          </div>

          <!-- OS -->
          <div class="form-row">
            <label>OS:</label>
            <input type="text" name="os" value="       /        ×   " class="os-input">
            <input type="text" name="oscl" class="oscl" style="display:none">
          </div>

          <!-- Addition -->
          <div class="form-row">
            <label>Addition:</label>
            <input type="text" name="axis" class="addition" maxlength="5" required>
          </div>

          <!-- PD -->
          <div class="form-row">
            <label>PD:</label>
            <input type="text" name="pd" class="pd" maxlength="5" required>
          </div>

          <!-- Submit -->
          <div class="form-row">
            <input type="submit" value="Submit">
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="success-message" style="display:none; color:green; margin-top:10px;">
    Refraction submitted successfully!
  </div>
    <div id="cl-message" style="display:none; color:green; margin-top:10px;">
      <p id="clodval"></p>
      <p id="closval"></p>
    </div>
  
  
  
  
</div>

<style>
/* Card styling */
.refraction-card {
  background: #ffffff;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  overflow: hidden;
  transition: all 0.3s ease;
}
.card-header {
  background: #f3f4f6;
  padding: 10px 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.card-title {
  font-weight: bold;
  color: #2c3e50;
}
.card-actions button {
  border: none;
  background: none;
  cursor: pointer;
  font-size: 18px;
  margin-left: 6px;
  color: #2980b9;
}
.card-actions button:hover {
  color: #1c5980;
}
.card-body {
  padding: 16px;
  display: block;
}
.form-row {
  display: flex;
  align-items: center;
  margin-bottom: 12px;
}
label {
  width: 100px;
  font-weight: bold;
  color: #16a085;
}
input[type="text"] {
  flex: 1;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  transition: border 0.2s ease;
}
input[type="text"]:focus {
  border-color: #2980b9;
  outline: none;
}
input.pd {
  width: 60px;
}
input.addition {
  width: 100px;
}
input[type="submit"] {
  background: #2980b9;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 14px;
  cursor: pointer;
  transition: background 0.2s ease;
}
input[type="submit"]:hover {
  background: #1c5980;
}
</style>

<script>
let formCounter = 1;

// ========== CONTACT LENS LOGIC ==========
function spectacleToCL(sph, cyl, axis, vertexDistance = 0.012) {
  sph = parseFloat(sph) || 0;
  cyl = parseFloat(cyl) || 0;
  axis = parseInt(axis) || 0;

  let clSph = sph / (1 - (vertexDistance * sph));
  let maxpow = (sph + cyl) / (1 - (vertexDistance * (sph + cyl)));

  clSph = Math.round(clSph * 4) / 4;
  let maxpowr = Math.round(maxpow * 4) / 4;

  let clCyl = Math.round((maxpowr - clSph) * 4) / 4;

  return {
    sphere: clSph,
    cylinder: clCyl,
    axis: clCyl === 0 ? null : axis
  };
}

function parsePrescription(inputValue) {
  let parts = inputValue.split(/[/×]/).map(p => p.trim());
  while (parts.length < 3) parts.push("");
  return { sphere: parts[0], cylinder: parts[1], axis: parts[2] };
}

// Run before submit: fill odcl/oscl values
function fillContactLensFields(form) {
  let odValue = form.querySelector(".od-input").value;
  let osValue = form.querySelector(".os-input").value;

  let result_od = parsePrescription(odValue);
  let result_os = parsePrescription(osValue);

  let cl_od = spectacleToCL(result_od.sphere, result_od.cylinder, result_od.axis);
  let cl_os = spectacleToCL(result_os.sphere, result_os.cylinder, result_os.axis);

  const odclVal = form.querySelector(".odcl").value;
  const osclVal = form.querySelector(".oscl").value;
form.querySelector(".odcl").value = `${cl_od.sphere}/${cl_od.cylinder}${cl_od.axis !== null ? "x" + cl_od.axis : ""}`;
form.querySelector(".oscl").value = `${cl_os.sphere}/${cl_os.cylinder}${cl_os.axis !== null ? "x" + cl_os.axis : ""}`;



// Show them in your message box
document.getElementById("clodval").textContent = "OD CL: " + `${cl_od.sphere}/${cl_od.cylinder}${cl_od.axis !== null ? "x" + cl_od.axis : ""}`;
document.getElementById("closval").textContent = "OS CL: " + `${cl_os.sphere}/${cl_os.cylinder}${cl_os.axis !== null ? "x" + cl_os.axis : ""}`;
document.getElementById("cl-message").style.display = "block";

}

// ========== DYNAMIC FORM MANAGEMENT ==========
document.addEventListener("click", function(e) {
  if (e.target.classList.contains("add-form")) {
    const card = e.target.closest(".refraction-card");
    const clone = card.cloneNode(true);

    formCounter++;
    clone.querySelector(".card-title").textContent = "Refraction Form #" + formCounter;

    // Reset fields
    clone.querySelectorAll("input[type=text]").forEach(inp => {
      if (inp.classList.contains("od-input") || inp.classList.contains("os-input")) {
        inp.value = "       /        ×   ";
      } else {
        inp.value = "";
      }
    });

    document.getElementById("refraction-forms").appendChild(clone);
  }

  if (e.target.classList.contains("remove-form")) {
    const card = e.target.closest(".refraction-card");
    if (document.querySelectorAll(".refraction-card").length > 1) {
      card.remove();
    } else {
      alert("At least one form must remain.");
    }
  }

  if (e.target.classList.contains("toggle-card")) {
    const card = e.target.closest(".refraction-card");
    const body = card.querySelector(".card-body");
    if (body.style.display === "none") {
      body.style.display = "block";
      e.target.textContent = "▼";
    } else {
      body.style.display = "none";
      e.target.textContent = "▲";
    }
  }
});

// ========== AJAX SUBMISSION ==========
document.addEventListener("submit", function(e) {
  if (e.target.classList.contains("refraction-form")) {
    e.preventDefault();

    const form = e.target;

    // Before submit → fill hidden contact lens fields
    fillContactLensFields(form);

    const formData = new FormData(form);

    fetch(form.action, {
      method: "POST",
      body: formData,
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(response => {
      if (!response.ok) throw new Error("Network error");
      return response.json();
    })
    .then(data => {
      document.getElementById("success-message").style.display = "block";

      // Collapse form after success
      const cardBody = form.closest(".card-body");
      cardBody.style.display = "none";
      form.closest(".refraction-card").querySelector(".toggle-card").textContent = "▲";

      // Update card title with Subject
      const subjectVal = form.querySelector("input[name=subject]").value;
      if (subjectVal) {
        form.closest(".refraction-card").querySelector(".card-title").textContent = "Refraction - " + subjectVal;
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("Something went wrong!");
    });
  }
});
</script>
