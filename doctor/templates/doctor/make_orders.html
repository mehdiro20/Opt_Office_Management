<!-- Make Orders Section -->
<div id="make-orders" class="section">
  <h3>Make Orders for this patient</h3>

  <!-- Order Form Row -->
  <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
    <input list="ordersList" id="orderInput" placeholder="Select or type order"
      style="padding:6px 12px; font-size:14px; border-radius:6px; border:1px solid #ccc; height:36px; min-width:150px;">
    <datalist id="ordersList">
      {% for order in orders %}
        <option value="{{ order.name }}"></option>
      {% endfor %}
    </datalist>

    <select id="prioritySelect" style="padding:6px 12px; font-size:14px; border-radius:6px; border:1px solid #ccc; height:36px;">
      <option value="high">High Priority</option>
      <option value="moderate">Moderate Priority</option>
      <option value="low">Low Priority</option>
    </select>

    <input type="number" id="taskDuration" placeholder="Duration (min)" min="1"
      style="width:130px; padding:6px 12px; font-size:14px; border-radius:6px; border:1px solid #ccc; height:36px;">

    <button onclick="addOrder()"
      style="padding:6px 14px; font-size:16px; border-radius:6px; background-color:#4CAF50; color:white; border:none; cursor:pointer; height:36px;">
      ‚ûï Add Order
    </button>

    <button id="editButton" onclick="toggleEditMode()"
      style="padding:6px 14px; font-size:16px; border-radius:6px; background-color:#f39c12; color:white; border:none; cursor:pointer; height:36px;">
      ‚úèÔ∏è Edit
    </button>
  </div>

  <!-- Action Buttons (Initially hidden) -->
  <div id="actionButtons" style="margin-bottom: 15px; display: none; gap: 10px;">
    <button onclick="removeSelected()" style="background:red; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">‚ùå Remove</button>
    <button onclick="changePrioritySelected()" style="background:green; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">P Change Priority</button>
    <button onclick="moveUpSelected()" style="background:#3498db; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">‚¨ÜÔ∏è Move Up</button>
    <button onclick="moveDownSelected()" style="background:#3498db; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">‚¨áÔ∏è Move Down</button>
  </div>

  <!-- Orders Table -->
  <table border="1" width="100%" id="ordersTable" style="border-collapse: collapse;">
    <thead>
      <tr>
        <th>#</th>
        <th>Order</th>
        <th>Duration (minutes)</th>
        <th class="editColumn" style="display:none;">Edit</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Save Button (Under Table) -->
  <div style="margin-top: 15px;">
    <button id="saveButton" onclick="saveOrdersToDB()"
      style="padding:8px 16px; font-size:16px; border-radius:6px; background-color:#3498db; color:white; border:none; cursor:pointer;">
      üíæ Save Orders
    </button>
  </div>
</div>

<script>
let ordersList = {{ existing_orders_json|safe }};  // Preload existing orders
let editMode = false;
const priorityColors = { high:"#f28b82", moderate:"#fbbc04", low:"#ccff90" };
const priorityOrder = ["high","moderate","low"];
const patientID = "{{ patient.id }}"; 

// Render orders on page load
document.addEventListener("DOMContentLoaded", () => {
    renderOrders();
});

function generateUniqueID(){
  return '_' + Math.random().toString(36).substr(2, 9);
}

// Add Order
function addOrder() {
  const orderInput = document.getElementById("orderInput").value.trim();
  const priority = document.getElementById("prioritySelect").value;
  const durationInput = document.getElementById("taskDuration").value;
  const duration = durationInput ? parseInt(durationInput) : null;

  if(!orderInput){ alert("Please enter or select an order."); return; }

  ordersList.push({ id: generateUniqueID(), order: orderInput, priority, duration, checked:false });
  renderOrders();

  document.getElementById("orderInput").value = "";
  document.getElementById("taskDuration").value = "";
}

// Render Orders Table
function renderOrders() {
  const tbody = document.querySelector("#ordersTable tbody");
  tbody.innerHTML = "";

  ordersList.forEach((o,index)=>{
    const row = document.createElement("tr");
    row.style.backgroundColor = priorityColors[o.priority];

    // Number
    const numberCell = document.createElement("td");
    numberCell.textContent = index+1;
    numberCell.style.textAlign = "center";

    // Order
    const orderCell = document.createElement("td");
    orderCell.textContent = o.order;

    // Duration
    const durationCell = document.createElement("td");
    durationCell.textContent = o.duration !== null ? o.duration : "-";

    // Row click editable
    row.addEventListener("click", (e)=>{
      if(editMode){
        const checkbox = row.querySelector("input[type='checkbox']");
        if(checkbox.checked && (e.target===orderCell || e.target===durationCell)){
          makeRowEditable(index);
        }
      }
    });

    // Edit checkbox column
    const editCell = document.createElement("td");
    editCell.classList.add("editColumn");
    editCell.style.textAlign = "center";
    editCell.style.display = editMode ? "table-cell" : "none";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = o.checked;
    checkbox.onchange = ()=>o.checked = checkbox.checked;
    editCell.appendChild(checkbox);

    row.appendChild(numberCell);
    row.appendChild(orderCell);
    row.appendChild(durationCell);
    row.appendChild(editCell);

    tbody.appendChild(row);
  });
}

// Make row editable
function makeRowEditable(index){
  const row = document.querySelectorAll("#ordersTable tbody tr")[index];
  const cells = row.querySelectorAll("td");

  const orderInput = document.createElement("input");
  orderInput.value = ordersList[index].order;
  orderInput.style.width = "100%";
  orderInput.onblur = () => { ordersList[index].order = orderInput.value; renderOrders(); };
  cells[1].innerHTML = "";
  cells[1].appendChild(orderInput);

  const durationInput = document.createElement("input");
  durationInput.type = "number";
  durationInput.min = 1;
  durationInput.value = ordersList[index].duration ?? "";
  durationInput.style.width = "80px";
  durationInput.onblur = () => { ordersList[index].duration = durationInput.value ? parseInt(durationInput.value): null; renderOrders(); };
  cells[2].innerHTML = "";
  cells[2].appendChild(durationInput);

  orderInput.focus();
}

// Toggle edit mode
function toggleEditMode(){
  editMode = !editMode;
  document.getElementById("actionButtons").style.display = editMode ? "flex" : "none";
  document.querySelectorAll(".editColumn").forEach(col => col.style.display = editMode ? "table-cell" : "none");
  renderOrders();
}

// Get selected rows
function getSelectedIndices(){
  return ordersList.map((o,i)=>o.checked ? i:-1).filter(i=>i!==-1);
}

// Action buttons
function removeSelected(){
  const indices = getSelectedIndices().sort((a,b)=>b-a);
  indices.forEach(i=>ordersList.splice(i,1));
  renderOrders();
}

function changePrioritySelected(){
  getSelectedIndices().forEach(i=>{
    const current = ordersList[i].priority;
    ordersList[i].priority = priorityOrder[(priorityOrder.indexOf(current)+1)%priorityOrder.length];
  });
  renderOrders();
}

function moveUpSelected(){
  const indices = getSelectedIndices();
  indices.forEach(i=>{
    if(i===0) return;
    [ordersList[i-1],ordersList[i]] = [ordersList[i],ordersList[i-1]];
  });
  renderOrders();
}

function moveDownSelected(){
  const indices = getSelectedIndices().slice().reverse();
  indices.forEach(i=>{
    if(i===ordersList.length-1) return;
    [ordersList[i+1],ordersList[i]] = [ordersList[i],ordersList[i+1]];
  });
  renderOrders();
}

// Save Orders to DB via POST
function saveOrdersToDB(){
  const form = document.createElement("form");
  form.method = "POST";
  form.action = "{% url 'doctor:save_orders' patient.patient_id %}";

  // CSRF token for Django
  const csrfToken = '{{ csrf_token }}';
  const csrfInput = document.createElement("input");
  csrfInput.type = "hidden";
  csrfInput.name = "csrfmiddlewaretoken";
  csrfInput.value = csrfToken;
  form.appendChild(csrfInput);

  // patient_id
  const patientInput = document.createElement("input");
  patientInput.type = "hidden";
  patientInput.name = "patient_id";
  patientInput.value = patientID;
  form.appendChild(patientInput);

  // orders as JSON string
  const ordersInput = document.createElement("input");
  ordersInput.type = "hidden";
  ordersInput.name = "orders_data";
  ordersInput.value = JSON.stringify(ordersList);
  form.appendChild(ordersInput);

  document.body.appendChild(form);
  form.submit();
}
</script>
