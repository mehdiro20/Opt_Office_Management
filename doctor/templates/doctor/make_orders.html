<!-- Make Orders Section -->
<div id="make-orders" class="section">
  <h3>Make Orders for this patient</h3>

  <!-- Order Form Row -->
  <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
    <input list="ordersList" id="orderInput" placeholder="Select or type order"
      style="padding:6px 12px; font-size:14px; border-radius:6px; border:1px solid #ccc; height:36px; min-width:150px;">
    <datalist id="ordersList">
      {% for order in orders %}
        <option value="{{ order.name }}"></option>
      {% endfor %}
    </datalist>

    <select id="prioritySelect" style="padding:6px 12px; font-size:14px; border-radius:6px; border:1px solid #ccc; height:36px;">
      <option value="high">High Priority</option>
      <option value="moderate">Moderate Priority</option>
      <option value="low">Low Priority</option>
    </select>

    <input type="number" id="taskDuration" placeholder="Duration (min)" min="1"
      style="width:130px; padding:6px 12px; font-size:14px; border-radius:6px; border:1px solid #ccc; height:36px;">

    <button onclick="addOrder()"
      style="padding:6px 14px; font-size:16px; border-radius:6px; background-color:#4CAF50; color:white; border:none; cursor:pointer; height:36px;">
      ➕ Add Order
    </button>

    <button id="editButton" onclick="toggleEditMode()"
      style="padding:6px 14px; font-size:16px; border-radius:6px; background-color:#f39c12; color:white; border:none; cursor:pointer; height:36px;">
      ✏️ Edit
    </button>
  </div>

  <!-- Action Buttons -->
  <div id="actionButtons" style="margin-bottom: 15px; display: none; gap: 10px;">
    <button onclick="removeSelected()" style="background:red; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">❌ Remove</button>
    <button onclick="changePrioritySelected()" style="background:green; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">P Change Priority</button>
    <button onclick="moveUpSelected()" style="background:#3498db; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">⬆️ Move Up</button>
    <button onclick="moveDownSelected()" style="background:#3498db; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">⬇️ Move Down</button>
  </div>

  <!-- Orders Table -->
  <table id="ordersTable" style="width:100%; border-collapse: collapse; border:none;">
    <thead>
      <tr>
        <th style="border:none;">#</th>
        <th style="border:none;">Order</th>
        <th style="border:none;">Duration (min)</th>
        <th class="editColumn" style="display:none; border:none;">Edit</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Save Button -->
  <div style="margin-top: 15px;">
    <button id="saveButton" onclick="saveOrdersToDB()"
      style="padding:8px 16px; font-size:16px; border-radius:6px; background-color:#3498db; color:white; border:none; cursor:pointer;">
      💾 Save Orders
    </button>
  </div>
</div>

<script>
let ordersList = {{ existing_orders_json|safe }};
let editMode = false;
const priorityColors = { high:"#f28b82", moderate:"#fbbc04", low:"#ccff90" };
const priorityOrder = ["high","moderate","low"];
const patientID = "{{ patient.id }}";

// Utility: generate unique ID
function generateUniqueID(){ return '_' + Math.random().toString(36).substr(2, 9); }

// Add Order & Auto-Save
function addOrder() {
  const orderInput = document.getElementById("orderInput").value.trim();
  const priority = document.getElementById("prioritySelect").value;
  const durationInput = document.getElementById("taskDuration").value;
  const duration = durationInput ? parseInt(durationInput) : null;

  if(!orderInput){ alert("Please enter or select an order."); return; }

  ordersList.push({ id: generateUniqueID(), order: orderInput, priority, duration, checked:false });
  renderOrders();
  saveOrdersToDB();  // Auto-save after adding

  document.getElementById("orderInput").value = "";
  document.getElementById("taskDuration").value = "";
}

// Render Orders Table
function renderOrders() {
  const tbody = document.querySelector("#ordersTable tbody");
  tbody.innerHTML = "";

  ordersList.forEach((o,index)=>{
    const row = document.createElement("tr");
    row.style.backgroundColor = priorityColors[o.priority] || "#fff";

    // Cells
    const tdNum = document.createElement("td");
    tdNum.textContent = index+1; tdNum.style.textAlign="center"; tdNum.style.border="none";

    const tdOrder = document.createElement("td");
    tdOrder.textContent = o.order; tdOrder.style.border="none";

    const tdDur = document.createElement("td");
    tdDur.textContent = o.duration !== null ? o.duration : "-"; tdDur.style.border="none";

    const tdEdit = document.createElement("td");
    tdEdit.classList.add("editColumn");
    tdEdit.style.textAlign = "center";
    tdEdit.style.display = editMode ? "table-cell" : "none";
    tdEdit.style.border="none";

    const checkbox = document.createElement("input");
    checkbox.type="checkbox";
    checkbox.checked = o.checked;
    checkbox.onchange = ()=>o.checked = checkbox.checked;
    tdEdit.appendChild(checkbox);

    // Click to edit
    row.addEventListener("click",(e)=>{
      if(editMode && checkbox.checked && (e.target===tdOrder || e.target===tdDur)) makeRowEditable(index);
    });

    row.appendChild(tdNum);
    row.appendChild(tdOrder);
    row.appendChild(tdDur);
    row.appendChild(tdEdit);

    tbody.appendChild(row);
  });
}

// Make row editable
function makeRowEditable(index){
  const row = document.querySelectorAll("#ordersTable tbody tr")[index];
  const cells = row.querySelectorAll("td");

  const orderInput = document.createElement("input");
  orderInput.value = ordersList[index].order;
  orderInput.style.width = "100%";
  orderInput.onblur = () => { ordersList[index].order = orderInput.value; renderOrders(); saveOrdersToDB(); };
  cells[1].innerHTML=""; cells[1].appendChild(orderInput);

  const durationInput = document.createElement("input");
  durationInput.type="number"; durationInput.min=1;
  durationInput.value = ordersList[index].duration ?? "";
  durationInput.style.width="80px";
  durationInput.onblur = () => { ordersList[index].duration = durationInput.value?parseInt(durationInput.value):null; renderOrders(); saveOrdersToDB(); };
  cells[2].innerHTML=""; cells[2].appendChild(durationInput);

  orderInput.focus();
}

// Toggle edit mode
function toggleEditMode(){
  editMode = !editMode;
  document.getElementById("actionButtons").style.display = editMode ? "flex" : "none";
  document.querySelectorAll(".editColumn").forEach(col=>col.style.display = editMode ? "table-cell":"none");
  renderOrders();
}

// Get selected indices
function getSelectedIndices(){ return ordersList.map((o,i)=>o.checked?i:-1).filter(i=>i!==-1); }

// Action buttons
function removeSelected(){ const idx=getSelectedIndices().sort((a,b)=>b-a); idx.forEach(i=>ordersList.splice(i,1)); renderOrders(); saveOrdersToDB(); }
function changePrioritySelected(){ getSelectedIndices().forEach(i=>{ const curr=ordersList[i].priority; ordersList[i].priority = priorityOrder[(priorityOrder.indexOf(curr)+1)%priorityOrder.length]; }); renderOrders(); saveOrdersToDB(); }
function moveUpSelected(){ const idx=getSelectedIndices(); idx.forEach(i=>{ if(i===0)return; [ordersList[i-1],ordersList[i]]=[ordersList[i],ordersList[i-1]]; }); renderOrders(); saveOrdersToDB(); }
function moveDownSelected(){ const idx=getSelectedIndices().slice().reverse(); idx.forEach(i=>{ if(i===ordersList.length-1)return; [ordersList[i+1],ordersList[i]]=[ordersList[i],ordersList[i+1]]; }); renderOrders(); saveOrdersToDB(); }

// Save to DB
function saveOrdersToDB(){
  const form = document.createElement("form");
  form.method="POST";
  form.action="{% url 'doctor:save_orders' patient.patient_id %}";

  const csrfInput=document.createElement("input");
  csrfInput.type="hidden"; csrfInput.name="csrfmiddlewaretoken"; csrfInput.value="{{ csrf_token }}";
  form.appendChild(csrfInput);

  const patientInput=document.createElement("input");
  patientInput.type="hidden"; patientInput.name="patient_id"; patientInput.value=patientID;
  form.appendChild(patientInput);

  const ordersInput=document.createElement("input");
  ordersInput.type="hidden"; ordersInput.name="orders_data"; ordersInput.value=JSON.stringify(ordersList);
  form.appendChild(ordersInput);

  document.body.appendChild(form);
  form.submit();
}

// Initial render
document.addEventListener("DOMContentLoaded",()=>{ renderOrders(); });
</script>
