<!-- === MAKE ORDERS SECTION === -->
<div id="make-orders" class="section">
  <h3>Make Orders for this patient</h3>

  <!-- Input Row -->
  <div style="display: flex; flex-direction: column; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
    <div style="display: flex; align-items: center; gap: 10px;">
      <label for="orderInput" style="font-weight:600; min-width:130px;">Type / Select Order:</label>
      <input list="ordersList" id="orderInput" placeholder="Select or type order"
        style="width:200px; padding:6px 12px; font-size:14px; border-radius:6px; border:1px solid #ccc; height:36px;">
      <datalist id="ordersList">
        {% for order in orders %}
          <option value="{{ order.name }}"></option>
        {% endfor %}
      </datalist>
    </div>

    <div style="display: flex; align-items: center; gap: 10px;">
      <label for="prioritySelect" style="font-weight:600; min-width:130px;">Priority:</label>
      <select id="prioritySelect"
        style="width:200px; padding:6px 12px; font-size:14px; border-radius:6px; border:1px solid #ccc; height:36px;">
        <option value="high">High Priority</option>
        <option value="moderate">Moderate Priority</option>
        <option value="low">Low Priority</option>
      </select>
    </div>

    <div style="display: flex; align-items: center; gap: 10px;">
      <label for="taskDuration" style="font-weight:600; min-width:130px;">Duration:</label>
      <input type="number" id="taskDuration" placeholder="Duration (min)" min="1"
        style="width:200px; padding:6px 12px; font-size:14px; border-radius:6px; border:1px solid #ccc; height:36px;">
    </div>
  </div>

  <!-- Add/Edit Buttons Row -->
  <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
    <button onclick="addOrder()"
      style="padding:6px 14px; font-size:16px; border-radius:6px; background-color:#4CAF50; color:white; border:none; cursor:pointer; height:36px;">
      ‚ûï Add Order
    </button>

    <button id="editButtonorder" onclick="toggleEditMode()"
      style="padding:6px 14px; font-size:16px; border-radius:6px; background-color:#4CAF50; color:white; border:none; cursor:pointer; height:36px;">
      ‚úèÔ∏è Edit
    </button>
  </div>

  <!-- Action Buttons (Shown in Edit Mode) -->
  <div id="actionButtons" style="margin-bottom: 15px; display: none; gap: 10px; flex-wrap:wrap;">
    <button onclick="removeSelected()" style="background:red; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">‚ùå Remove</button>
    <button onclick="changePrioritySelected()" style="background:green; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">P Change Priority</button>
    <button onclick="moveUpSelected()" style="background:#3498db; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">‚¨ÜÔ∏è Move Up</button>
    <button onclick="moveDownSelected()" style="background:#3498db; color:white; padding:6px 12px; border-radius:6px; border:none; cursor:pointer;">‚¨áÔ∏è Move Down</button>
  </div>

  <!-- Orders Table -->
  <table id="ordersTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Order</th>
        <th>Duration (min)</th>
        <th class="editColumn" style="display:none;">Edit</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Save Button -->
  <div style="margin-top: 15px;">
    <button id="saveButton" onclick="saveOrdersToDB()"
      style="padding:8px 16px; font-size:16px; border-radius:6px; background-color:#3498db; color:white; border:none; cursor:pointer;">
      üíæ Save Orders
    </button>
  </div>
</div>

<!-- === TABLE STYLES (Blue Headers + Matching Design) === -->
<style>
  #ordersTable {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    word-wrap: break-word;
  }

  #ordersTable th, #ordersTable td {
    border: 1px solid #ddd;
    padding: 6px 8px;
    text-align: center;
  }

  /* üîµ Blue header style */
  #ordersTable th {
    background-color: #007BFF;
    color: white;
    font-weight: 600;
  }

  #ordersTable td input.edit-input {
    width: 95%;
    box-sizing: border-box;
    padding: 3px 6px;
    font-size: 0.9rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  #ordersTable td input.edit-input:focus {
    outline: 2px solid #4a90e2;
    background-color: #f9fcff;
  }

  #ordersTable td:nth-child(1) { width: 50px; }
  #ordersTable td:nth-child(2) { width: 200px; }
  #ordersTable td:nth-child(3) { width: 120px; }
  #ordersTable td input.edit-input { width: 95%; box-sizing: border-box; padding: 3px 6px; font-size: 0.9rem; border: 1px solid #ccc; border-radius: 4px; }
  #ordersTable td input.edit-input:focus { outline: 2px solid #4a90e2; background-color: #f9fcff; }

  @media (max-width: 768px) {
    #ordersTable td input.edit-input {
      font-size: 0.8rem;
      width: 100%;
    }
    #ordersTable td:nth-child(2) { width: 150px; }
  }

  /* Inputs and selects fixed to 120px width */
  #make-orders input[type="text"],
  #make-orders input[type="number"],
  #make-orders select {
    width: 200px !important;
  }
</style>

<!-- === SCRIPT === -->
<script>
let ordersList = {{ existing_orders_json|safe }};
let editMode = false;
const priorityColors = { high:"#f28b82", moderate:"#fbbc04", low:"#ccff90" };
const priorityOrder = ["high","moderate","low"];
const patientID = "{{ patient.id }}";

function generateUniqueID(){ return '_' + Math.random().toString(36).substr(2, 9); }

function addOrder() {
  const orderInput = document.getElementById("orderInput").value.trim();
  const priority = document.getElementById("prioritySelect").value;
  const durationInput = document.getElementById("taskDuration").value;
  const duration = durationInput ? parseInt(durationInput) : null;

  if(!orderInput){ alert("Please enter or select an order."); return; }

  ordersList.push({ id: generateUniqueID(), order: orderInput, priority, duration, checked:false });
  renderOrders();
  saveOrdersToDB();

  document.getElementById("orderInput").value = "";
  document.getElementById("taskDuration").value = "";
}

function renderOrders() {
  const tbody = document.querySelector("#ordersTable tbody");
  tbody.innerHTML = "";

  ordersList.forEach((o,index)=>{
    const row = document.createElement("tr");
    row.style.backgroundColor = priorityColors[o.priority] || "#fff";

    const tdNum = document.createElement("td");
    tdNum.textContent = index+1;

    const tdOrder = document.createElement("td");
    tdOrder.textContent = o.order;

    const tdDur = document.createElement("td");
    tdDur.textContent = o.duration !== null ? o.duration : "-";

    const tdEdit = document.createElement("td");
    tdEdit.classList.add("editColumn");
    tdEdit.style.textAlign = "center";
    tdEdit.style.display = editMode ? "table-cell" : "none";

    const checkbox = document.createElement("input");
    checkbox.type="checkbox";
    checkbox.checked = o.checked;
    checkbox.onchange = ()=>o.checked = checkbox.checked;
    tdEdit.appendChild(checkbox);

    row.addEventListener("click",(e)=>{
      if(editMode && checkbox.checked && (e.target===tdOrder || e.target===tdDur)) makeRowEditable(index);
    });

    row.appendChild(tdNum);
    row.appendChild(tdOrder);
    row.appendChild(tdDur);
    row.appendChild(tdEdit);
    tbody.appendChild(row);
  });
}

function makeRowEditable(index) {
  const row = document.querySelectorAll("#ordersTable tbody tr")[index];
  const cells = row.querySelectorAll("td");

  const inputs = ["order","duration"].map((key,i)=>{
    const inp = document.createElement("input");
    inp.value = ordersList[index][key] ?? "";
     inp.className="edit-input";
    inp.type = (key==="duration") ? "number" : "text";
    if(key==="duration") inp.min = 1;
    cells[i+1].innerHTML = "";
    cells[i+1].appendChild(inp);
    return inp;
  });

  function saveValues() {
    ["order","duration"].forEach((k,i)=>{
      ordersList[index][k] = (k==="duration") ? (inputs[i].value ? parseInt(inputs[i].value) : null) : inputs[i].value;
    });
  }

  inputs.forEach((input,i)=>{
    input.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" || e.key==="Tab") {
        e.preventDefault();
        saveValues();
        if(inputs[i+1]) inputs[i+1].focus();
        else renderOrders();
      }
    });
    input.addEventListener("blur",()=>{
      saveValues();
      if(input===inputs[1]) setTimeout(()=>renderOrders(), 100);
    });
  });

  setTimeout(()=>inputs[0].focus(),0);
}

function toggleEditMode(){
  const btn=document.getElementById("editButtonorder");

  editMode = !editMode;
  btn.style.background=editMode?"red":"#4CAF50"; 
  document.getElementById("actionButtons").style.display = editMode ? "flex" : "none";
  document.querySelectorAll(".editColumn").forEach(col=>col.style.display = editMode ? "table-cell":"none");
  renderOrders();
}

function getSelectedIndices(){ return ordersList.map((o,i)=>o.checked?i:-1).filter(i=>i!==-1); }

function removeSelected(){ const idx=getSelectedIndices().sort((a,b)=>b-a); idx.forEach(i=>ordersList.splice(i,1)); renderOrders(); saveOrdersToDB(); }
function changePrioritySelected(){ getSelectedIndices().forEach(i=>{ const curr=ordersList[i].priority; ordersList[i].priority = priorityOrder[(priorityOrder.indexOf(curr)+1)%priorityOrder.length]; }); renderOrders(); saveOrdersToDB(); }
function moveUpSelected(){ const idx=getSelectedIndices(); idx.forEach(i=>{ if(i===0)return; [ordersList[i-1],ordersList[i]]=[ordersList[i],ordersList[i-1]]; }); renderOrders(); saveOrdersToDB(); }
function moveDownSelected(){ const idx=getSelectedIndices().slice().reverse(); idx.forEach(i=>{ if(i===ordersList.length-1)return; [ordersList[i+1],ordersList[i]]=[ordersList[i],ordersList[i+1]]; }); renderOrders(); saveOrdersToDB(); }

function saveOrdersToDB(){
  const form = document.createElement("form");
  form.method="POST";
  form.action="{% url 'doctor:save_orders' patient.patient_id %}";

  const csrfInput=document.createElement("input");
  csrfInput.type="hidden"; csrfInput.name="csrfmiddlewaretoken"; csrfInput.value="{{ csrf_token }}";
  form.appendChild(csrfInput);

  const patientInput=document.createElement("input");
  patientInput.type="hidden"; patientInput.name="patient_id"; patientInput.value=patientID;
  form.appendChild(patientInput);

  const ordersInput=document.createElement("input");
  ordersInput.type="hidden"; ordersInput.name="orders_data"; ordersInput.value=JSON.stringify(ordersList);
  form.appendChild(ordersInput);

  document.body.appendChild(form);
  form.submit();
}

document.addEventListener("DOMContentLoaded",()=>{ renderOrders(); });
</script>
