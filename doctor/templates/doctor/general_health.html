<div id="general_health" class="section">
  <h3>General Health Overview</h3>

  <form id="generalHealthForm" method="POST" action="{% url 'doctor:general_health_record' patient.patient_id %}">
    {% csrf_token %}
         <h1>{{ selected_data.systemic}}</h1>
    <!-- Systemic Diseases -->
    <div class="info-card card-body collapsible-section">
      <div class="section-header" id="systemicHeader">
        <div style="display:flex; gap:6px; align-items:center;">
          <button type="button" class="add-form" onclick="addPatientItem('systemic',event)">âž•</button>
          <button type="button" class="remove-form" onclick="removePatientItem('systemic',event)">âž–</button>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <span class="section-title">Systemic Diseases</span>
          <button type="button" class="section-chevron" id="systemicChevron">â–¼</button>
        </div>
      </div>
      <div class="section-body" id="systemicBody" style="margin-top:8px; padding:6px; display:flex; flex-wrap:wrap; gap:10px;">
        {% for cond in health_conditions %}
   
          <div class="checkbox-label">
            <label>{{ cond.name }}
              <input type="checkbox" name="systemic_checkbox" value="{{ cond.name }}"
                     {% if cond.name in selected_data.health_conditions %}checked{% endif %}>
            </label>
          </div>
        {% endfor %}
        <input type="hidden" name="systemic_selected" id="systemic_selected">
      </div>
    </div>

    <!-- Ocular History -->
    <div class="info-card card-body collapsible-section">
      <div class="section-header" id="ocular_historyHeader">
        <div style="display:flex; gap:6px; align-items:center;">
          <button type="button" class="add-form" onclick="addPatientItem('ocular_history',event)">âž•</button>
          <button type="button" class="remove-form" onclick="removePatientItem('ocular_history',event)">âž–</button>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <span class="section-title">Ocular History</span>
          <button type="button" class="section-chevron" id="ocular_historyChevron">â–¼</button>
        </div>
      </div>
      <div class="section-body" id="ocular_historyBody" style="margin-top:8px; padding:6px; display:flex; flex-wrap:wrap; gap:10px;">
        {% for cond in ocular_history %}
          <div class="checkbox-label">
            <label>{{ cond.name }}
              <input type="checkbox" name="ocular_history_checkbox" value="{{ cond.name }}"
                     {% if cond.name in selected_data.ocular_history %}checked{% endif %}>
            </label>
          </div>
        {% endfor %}
        <input type="hidden" name="ocular_history_selected" id="ocular_history_selected">
      </div>
    </div>

    <!-- Medications -->
    <div class="info-card card-body collapsible-section">
      <div class="section-header" id="medicationsHeader">
        <div style="display:flex; gap:6px; align-items:center;">
          <button type="button" class="add-form" onclick="addPatientItem('medications',event)">âž•</button>
          <button type="button" class="remove-form" onclick="removePatientItem('medications',event)">âž–</button>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <span class="section-title">Medications</span>
          <button type="button" class="section-chevron" id="medicationsChevron">â–¼</button>
        </div>
      </div>
      <div class="section-body" id="medicationsBody" style="margin-top:8px; padding:6px; display:flex; flex-wrap:wrap; gap:10px;">
        {% for cond in medications %}
          <div class="checkbox-label">
            <label>{{ cond.name }}
              <input type="checkbox" name="medications_checkbox" value="{{ cond.name }}"
                     {% if cond.name in selected_data.medications %}checked{% endif %}>
            </label>
          </div>
        {% endfor %}
        <input type="hidden" name="medications_selected" id="medications_selected">
      </div>
    </div>

    <!-- Allergies -->
    <div class="info-card card-body collapsible-section">
      <div class="section-header" id="allergiesHeader">
        <div style="display:flex; gap:6px; align-items:center;">
          <button type="button" class="add-form" onclick="addPatientItem('allergies',event)">âž•</button>
          <button type="button" class="remove-form" onclick="removePatientItem('allergies',event)">âž–</button>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <span class="section-title">Allergies</span>
          <button type="button" class="section-chevron" id="allergiesChevron">â–¼</button>
        </div>
      </div>
      <div class="section-body" id="allergiesBody" style="margin-top:8px; padding:6px; display:flex; flex-wrap:wrap; gap:10px;">
        {% for cond in allergies %}
          <div class="checkbox-label">
            <label>{{ cond.name }}
              <input type="checkbox" name="allergies_checkbox" value="{{ cond.name }}"
                     {% if cond.name in selected_data.allergies %}checked{% endif %}>
            </label>
          </div>
        {% endfor %}
        <input type="hidden" name="allergies_selected" id="allergies_selected">
      </div>
    </div>

    <!-- Familial History -->
    <div class="info-card card-body collapsible-section">
      <div class="section-header" id="familial_historyHeader">
        <div style="display:flex; gap:6px; align-items:center;">
          <button type="button" class="add-form" onclick="addPatientItem('familial_history',event)">âž•</button>
          <button type="button" class="remove-form" onclick="removePatientItem('familial_history',event)">âž–</button>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <span class="section-title">Familial History</span>
          <button type="button" class="section-chevron" id="familial_historyChevron">â–¼</button>
        </div>
      </div>
      <div class="section-body" id="familial_historyBody" style="margin-top:8px; padding:6px; display:flex; flex-wrap:wrap; gap:10px;">
        {% for cond in familial_history %}
          <div class="checkbox-label">
            <label>{{ cond.name }}
              <input type="checkbox" name="familial_history_checkbox" value="{{ cond.name }}"
                     {% if cond.name in selected_data.familial_history %}checked{% endif %}>
            </label>
          </div>
        {% endfor %}
        <input type="hidden" name="familial_history_selected" id="familial_history_selected">
      </div>
    </div>

    <!-- Genetical History -->
    <div class="info-card card-body collapsible-section">
      <div class="section-header" id="genetical_historyHeader">
        <div style="display:flex; gap:6px; align-items:center;">
          <button type="button" class="add-form" onclick="addPatientItem('genetical_history',event)">âž•</button>
          <button type="button" class="remove-form" onclick="removePatientItem('genetical_history',event)">âž–</button>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <span class="section-title">Genetical History</span>
          <button type="button" class="section-chevron" id="genetical_historyChevron">â–¼</button>
        </div>
      </div>
      <div class="section-body" id="genetical_historyBody" style="margin-top:8px; padding:6px; display:flex; flex-wrap:wrap; gap:10px;">
        {% for cond in genetical_history %}
          <div class="checkbox-label">
            <label>{{ cond.name }}
              <input type="checkbox" name="genetical_history_checkbox" value="{{ cond.name }}"
                     {% if cond.name in selected_data.genetical_history %}checked{% endif %}>
            </label>
          </div>
        {% endfor %}
        <input type="hidden" name="genetical_history_selected" id="genetical_history_selected">
      </div>
    </div>

    <!-- Lifestyle History -->
    <div class="info-card card-body collapsible-section">
      <div class="section-header" id="lifestyle_historyHeader">
        <div style="display:flex; gap:6px; align-items:center;">
          <button type="button" class="add-form" onclick="addPatientItem('lifestyle_history',event)">âž•</button>
          <button type="button" class="remove-form" onclick="removePatientItem('lifestyle_history',event)">âž–</button>
        </div>
        <div style="display:flex; align-items:center; gap:6px;">
          <span class="section-title">Lifestyle History</span>
          <button type="button" class="section-chevron" id="lifestyle_historyChevron">â–¼</button>
        </div>
      </div>
      <div class="section-body" id="lifestyle_historyBody" style="margin-top:8px; padding:6px; display:flex; flex-wrap:wrap; gap:10px;">
        {% for cond in lifestyle_history %}
          <div class="checkbox-label">
            <label>{{ cond.name }}
              <input type="checkbox" name="lifestyle_history_checkbox" value="{{ cond.name }}"
                     {% if cond.name in selected_data.lifestyle_history %}checked{% endif %}>
            </label>
          </div>
        {% endfor %}
        <input type="hidden" name="lifestyle_history_selected" id="lifestyle_history_selected">
      </div>
    </div>

    <div style="margin-top:20px;">
      <button type="submit" class="add_order_btn">ðŸ’¾ Submit General Health</button>
    </div>
  </form>
</div>

<!-- keep same CSS -->
<style>
.section-title { font-weight: bold; color: #2c3e50; }
.section-header { display:flex; justify-content:space-between; align-items:center; background:#f3f4f6; padding:6px 10px; border-radius:6px; cursor:pointer; }
.section-header:hover{ background:#e9f5f3; }
.section-chevron { border:none; background:none; font-size:20px; font-weight:bold; cursor:pointer; color:#2980b9; transition: transform 0.25s ease, color 0.2s ease; }
.section-chevron:hover, .section-chevron:focus { color:#1c5980; outline:none; transform: scale(1.15); }
.section-chevron.rotate { transform:rotate(180deg); }
.checkbox-label label { display: flex; align-items: center; gap: 6px; padding: 4px 8px; min-width: max-content; cursor: pointer; }
.checkbox-label input[type="checkbox"] { order: 2; }
.checkbox-label:hover{ transform: scale(1.05)}
input[type="checkbox"]{ accent-color: #007bff; cursor: pointer; width: 13px; height: 13px; }
.add-form, .remove-form { border:none; color:white; font-size:14px; font-weight:bold; padding:2px 6px; border-radius:4px; cursor:pointer; transition: background 0.2s; }
.add-form:hover {color:#1c5980; outline:none; transform: scale(1.15); }
.remove-form:hover { color:#1c5980; outline:none; transform: scale(1.15); }
</style>
<script>
document.addEventListener("DOMContentLoaded", function() {
  // toggle open/close for collapsible sections
  function toggleSection(headerId, bodyId, chevronId){
    const body = document.getElementById(bodyId);
    const chevron = document.getElementById(chevronId);
    const hidden = body.style.display === "none";
    body.style.display = hidden ? "flex" : "none";
    chevron.classList.toggle("rotate", hidden);
  }

  // all sections list
  const sections = [
    ["systemicHeader","systemicBody","systemicChevron","systemic"],
    ["ocular_historyHeader","ocular_historyBody","ocular_historyChevron","ocular_history"],
    ["medicationsHeader","medicationsBody","medicationsChevron","medications"],
    ["allergiesHeader","allergiesBody","allergiesChevron","allergies"],
    ["familial_historyHeader","familial_historyBody","familial_historyChevron","familial_history"],
    ["genetical_historyHeader","genetical_historyBody","genetical_historyChevron","genetical_history"],
    ["lifestyle_historyHeader","lifestyle_historyBody","lifestyle_historyChevron","lifestyle_history"]
  ];

  // enable section toggles
  sections.forEach(([header, body, chevron])=>{
    const el = document.getElementById(header);
    if(el) el.addEventListener("click", ()=>toggleSection(header, body, chevron));
  });

  // return all checked values for a section
  function getCheckedValues(sectionName){
    const inputs = document.querySelectorAll(`input[name="${sectionName}_checkbox"]:checked`);
    return Array.from(inputs).map(inp => inp.value);
  }

  // fill hidden input with comma-separated values (no brackets)
  function fillHiddenSelected(sectionName){
    const hidden = document.getElementById(`${sectionName}_selected`);
    if(!hidden) return;
    const values = getCheckedValues(sectionName);
    hidden.value = values.join(", ");  // plain string
  }

  // before submitting the form, store all selections
  const form = document.getElementById("generalHealthForm");
  if(form){
    form.addEventListener("submit", function(){
      sections.forEach(([_h,_b,_c,sectionName])=>{
        fillHiddenSelected(sectionName);
      });
    });
  }
});

// Add new condition dynamically
function addPatientItem(sectionName, e){
  e.stopPropagation();
  const item = prompt("Enter new item for " + sectionName.replaceAll("_"," "));
  if(!item) return;

  const form = document.createElement("form");
  form.method="POST";
  form.action="{% url 'doctor:add_patient_item' patient.patient_id %}";

  const csrf=document.createElement("input");
  csrf.type="hidden";csrf.name="csrfmiddlewaretoken";csrf.value="{{ csrf_token }}";
  form.appendChild(csrf);

  const s=document.createElement("input");
  s.type="hidden";s.name="section_name";s.value=sectionName;
  form.appendChild(s);

  const n=document.createElement("input");
  n.type="hidden";n.name="item_name";n.value=item;
  form.appendChild(n);

  document.body.appendChild(form);
  form.submit();
}

// Remove selected item dynamically
function removePatientItem(sectionName, e){
  e.stopPropagation();
  const body=document.getElementById(sectionName+"Body");
  const checked=body.querySelectorAll(`input[name="${sectionName}_checkbox"]:checked`);
  if(checked.length===0){alert("No selected item to remove.");return;}

  const itemName=checked[checked.length-1].value;

  const form=document.createElement("form");
  form.method="POST";
  form.action="{% url 'doctor:delete_patient_item' patient.patient_id %}";

  const csrf=document.createElement("input");
  csrf.type="hidden";csrf.name="csrfmiddlewaretoken";csrf.value="{{ csrf_token }}";
  form.appendChild(csrf);

  const s=document.createElement("input");
  s.type="hidden";s.name="section_name";s.value=sectionName;
  form.appendChild(s);

  const n=document.createElement("input");
  n.type="hidden";n.name="item_name";n.value=itemName;
  form.appendChild(n);

  document.body.appendChild(form);
  form.submit();
}
</script>
