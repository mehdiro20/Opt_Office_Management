<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secretary Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f7fa; }
        h1 { color: #2c3e50; }

        .actions { margin-bottom: 20px; }
        .actions a {
            display: inline-block; margin-right: 15px; padding: 10px 15px;
            background-color: #3498db; color: white; text-decoration: none; border-radius: 6px; cursor: pointer;
        }
        .actions a:hover { background-color: #2980b9; }

        /* Filter section */
        .filter {
            margin-bottom: 20px; padding: 10px; background: #fff; border-radius: 6px;
            display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
        }
        .filter input, .filter select, .filter button {
            padding: 6px 10px; border-radius: 4px; border: 1px solid #ccc;
        }
        .filter button { background-color: #3498db; color: white; border: none; cursor: pointer; }
        .filter button:hover { background-color: #2980b9; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #3498db; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .status-accepted { color: green; font-weight: bold; }
        .status-waiting { color: red; font-weight: bold; }
        .status-done { color: gray; font-weight: bold; }

        /* Action buttons in table (optional classes you may use in partial) */
        .accept-button, .remove-button, .done-button, .get-lr-button {
            padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;
            transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .accept-button { background-color: #28a745; color: white; }
        .accept-button:hover { background-color: #218838; transform: translateY(-2px); }
        .get-lr-button { background-color: #007bff; color: white; }
        .get-lr-button:hover { background-color: #0069d9; transform: translateY(-2px); }
        .remove-button { background-color: #e74c3c; color: white; }
        .remove-button:hover { background-color: #c0392b; transform: translateY(-2px); }
        .done-button { background-color: #2e7d32; color: white; }
        .done-button:hover { background-color: #1b5e20; transform: translateY(-2px); }

        /* Modal (Register Patient) */
        .modal {
            display: none; position: fixed; z-index: 1000; inset: 0;
            background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
            animation: fadeIn 0.25s ease;
        }
        .modal-content {
            background: #fff; padding: 22px; width: 520px; max-width: 95%;
            border-radius: 12px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            animation: slideDown 0.25s ease;
        }
        .close-btn {
            position: absolute; right: 14px; top: 10px; font-size: 22px; font-weight: bold; cursor: pointer; color: #666;
        }
        .close-btn:hover { color: #000; }
        .modal-content h2 { margin: 0 0 14px 0; color: #2c3e50; }

        .modal-content label { display: block; margin-top: 10px; font-weight: bold; color: #34495e; }
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%; padding: 8px; margin-top: 6px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box;
        }
        .modal-content textarea { resize: vertical; }

        .modal-content button[type="submit"] {
            margin-top: 16px; background-color: #3498db; color: white; border: none; padding: 10px 15px;
            border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px;
        }
        .modal-content button[type="submit"]:hover { background-color: #2980b9; }

        .error-message {
            color: #e74c3c; margin-top: 10px; font-size: 14px; display: none;
        }
        .success-toast {
            position: fixed; right: 20px; bottom: 20px; background: #28a745; color: #fff;
            padding: 10px 14px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none; z-index: 1100;
        }

        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        @keyframes slideDown { from {transform: translateY(-16px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
    </style>
</head>
<body>
<h1>Secretary Dashboard</h1>

<div class="actions">
    <a onclick="openRegisterModal()">‚ûï Register New Patient</a>
    <a href="{% url 'secretary:accept_existing_patient' %}">‚úÖ Accept Existing Patient by ID</a>
    <a href="{% url 'secretary:get_patient_last_refraction_t2' %}">üëÅ Get Patient Last Refraction</a>
</div>

<!-- Filter Form -->
<div class="filter">
    <form id="filter-form" method="GET">
        <label>Start Date:</label>
        <input type="date" name="start_date" value="{{ request.GET.start_date }}">
        <label>End Date:</label>
        <input type="date" name="end_date" value="{{ request.GET.end_date }}">
        <label>Status:</label>
        <select name="status">
            <option value="">All</option>
            <option value="waiting" {% if request.GET.status == 'waiting' %}selected{% endif %}>Waiting</option>
            <option value="accepted" {% if request.GET.status == 'accepted' %}selected{% endif %}>Accepted</option>
            <option value="done" {% if request.GET.status == 'done' %}selected{% endif %}>Done</option>
        </select>
        <label><input type="checkbox" name="keep_dismissed" {% if request.GET.keep_dismissed %}checked{% endif %}> Keep Dismissed Visible</label>
        <button type="submit">Apply Filter</button>
    </form>
</div>

<!-- Patients Table -->
<h2>All Patients</h2>
<div id="patients-table">
    {% include "secretary/patients_table.html" %}
</div>

<!-- Register Patient Modal -->
{% include "secretary/register_patient_modal.html" %}
<!-- Success toast -->

<div id="successToast" class="success-toast">Patient registered successfully.</div>

<script>
    // ---- Local storage dismiss handling (for patients rows) ----
    const dismissedKey = "dismissedPatients";
    function getDismissed() { return JSON.parse(localStorage.getItem(dismissedKey) || "[]"); }
    function setDismissed(arr) { localStorage.setItem(dismissedKey, JSON.stringify(arr)); }

    function attachDismissHandlers() {
        document.querySelectorAll('.dismiss-button').forEach(button => {
            button.addEventListener('click', () => {
                const patientId = button.dataset.patientId;
                const row = document.getElementById(`patient-${patientId}`);
                if (row) row.style.display = 'none';
                const dismissed = getDismissed();
                if (!dismissed.includes(patientId)) {
                    dismissed.push(patientId);
                    setDismissed(dismissed);
                }
            });
        });
    }

    function hideDismissedRows() {
        const dismissed = getDismissed();
        const urlParams = new URLSearchParams(window.location.search);
        const keepDismissed = urlParams.has('keep_dismissed');
        if (!keepDismissed) {
            dismissed.forEach(id => {
                const row = document.getElementById(`patient-${id}`);
                if (row) row.style.display = 'none';
            });
        }
    }

    function refreshPatientsTable() {
        const params = new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString();
        fetch("{% url 'secretary:patients_table_partial' %}?" + params, { headers: { "X-Requested-With": "XMLHttpRequest" } })
            .then(res => res.text())
            .then(html => {
                document.getElementById("patients-table").innerHTML = html;
                attachDismissHandlers();
                hideDismissedRows();
            })
            .catch(() => {});
    }

    // ---- Modal controls ----
    function openRegisterModal() {
        document.getElementById("registerModal").style.display = "flex";
        document.getElementById("registerModal").setAttribute("aria-hidden", "false");
        document.getElementById("rp_name").focus();
    }
    function closeRegisterModal() {
        document.getElementById("registerModal").style.display = "none";
        document.getElementById("registerModal").setAttribute("aria-hidden", "true");
        const err = document.getElementById("formError");
        err.textContent = ""; err.style.display = "none";
        document.getElementById("registerForm").reset();
    }
    window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeRegisterModal();
    });
    window.addEventListener("click", (event) => {
        const modal = document.getElementById("registerModal");
        if (event.target === modal) closeRegisterModal();
    });

    // ---- CSRF helper (Django) ----
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    // ---- AJAX Register Form ----
    document.getElementById("registerForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const form = this;
        const errorBox = document.getElementById("formError");
        errorBox.textContent = ""; errorBox.style.display = "none";

        const formData = new FormData(form);

        fetch(form.action, {
            method: "POST",
            body: formData,
            headers: {
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": csrftoken
            }
        })
        .then(async res => {
            const ct = res.headers.get("content-type") || "";
            if (!ct.includes("application/json")) {
                // If the server responded with HTML (e.g., form errors rendered), show generic error
                const text = await res.text();
                throw new Error("Unexpected response from server.");
            }
            return res.json();
        })
        .then(data => {
            if (data.success) {
                closeRegisterModal();
                showToast();
                refreshPatientsTable();
            } else {
                errorBox.textContent = data.error || "An error occurred.";
                errorBox.style.display = "block";
            }
        })
        .catch(err => {
            errorBox.textContent = err.message || "Server error. Please try again.";
            errorBox.style.display = "block";
        });
    });

    function showToast() {
        const t = document.getElementById("successToast");
        t.style.display = "block";
        setTimeout(() => t.style.display = "none", 2200);
    }

    // ---- Init ----
    attachDismissHandlers();
    hideDismissedRows();
    setInterval(refreshPatientsTable, 5000);
</script>
</body>
</html>
