{% extends "base.html" %}

{% block title %}Secretary Dashboard{% endblock %}

{% block content %}
<style>
/* ================= Body & Headers ================= */
body { font-family: Arial, sans-serif; margin: 0; background-color: #f5f7fa; }
h1 { color: #2c3e50; margin: 20px; }

/* ================= Top Menu Bar ================= */
.menu-bar {
    display: flex;
    gap: 10px;
    background: #3498db;
    padding: 12px 20px;
    border-radius: 0 0 16px 16px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    position: sticky;
    top: 0;
    z-index: 900;
}
.menu-bar .menu-item {
    position: relative;
    background: white;
    color: #3498db;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.menu-bar .menu-item:hover { background: #ecf5ff; transform: translateY(-2px); }

.menu-bar .submenu {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    min-width: 230px;
    flex-direction: column;
    z-index: 1000;
    transition: opacity 0.25s ease, visibility 0.25s ease;
}
.menu-bar .menu-item:hover .submenu,
.menu-bar .menu-item.active .submenu {
    visibility: visible;
    opacity: 1;
}
.menu-bar .submenu a {
    padding: 10px 16px;
    display: block;
    text-decoration: none;
    color: #3498db;
    font-weight: normal;
    transition: background 0.2s;
    white-space: nowrap;
}
.menu-bar .submenu a:hover { background: #ecf5ff; }

/* ================= Filter ================= */
.filter {
    margin: 20px; padding: 10px; background: #fff; border-radius: 8px;
    display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.filter input, .filter select, .filter button {
    padding: 6px 10px; border-radius: 4px; border: 1px solid #ccc;
}
.filter button { background-color: #3498db; color: white; border: none; cursor: pointer; }
.filter button:hover { background-color: #2980b9; }

/* ================= Table ================= */
table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; }
th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
th { background-color: #3498db; color: white; }
tr:nth-child(even) { background-color: #f2f2f2; }
.status-accepted { color: green; font-weight: bold; }
.status-waiting { color: red; font-weight: bold; }
.status-waiting_out { color: #e94e3c; font-weight: bold; }
.status-done { color: gray; font-weight: bold; }

/* Buttons inside table */
.accept-button, .remove-button, .done-button, .get-lr-button, .get-so-button {
    padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;
    transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}
.accept-button { background-color: #28a745; color: white; }
.accept-button:hover { background-color: #218838; transform: translateY(-2px); }
.get-lr-button { background-color: #007bff; color: white; }
.get-lr-button:hover { background-color: #0069d9; transform: translateY(-2px); }
.get-so-button { background-color: #e94e3c; color: white; }
.get-so-button:hover { background-color: #ef5350; transform: translateY(-2px); }
.remove-button { background-color: #e74c3c; color: white; }
.remove-button:hover { background-color: #c0392b; transform: translateY(-2px); }
.done-button { background-color: #2e7d32; color: white; }
.done-button:hover { background-color: #1b5e20; transform: translateY(-2px); }

/* ================= Toast ================= */
.toast {
    position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
    padding: 12px 20px; border-radius: 8px; display: none; z-index: 1000;
}
.toast.error { background: #e74c3c; }

/* ================= Modal ================= */
.modal {
    display: none;
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    justify-content: center; align-items: center;
    z-index: 1000;
  
}
.modal-overlay {
    position: absolute;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
}
.modal-content {
    position: relative;
    background: white;
    padding: 20px;
    border-radius: 8px;
    z-index: 1001;
    max-height: 80%;
    overflow-y: auto;
}
.modal-header {
    display: flex; justify-content: space-between; align-items: center;
}
.modal-body { margin-top: 10px; }
</style>

<h1>Secretary Dashboard</h1>
<!-- Modals -->
{% include "secretary/register_patient_modal.html" %}
{% include "secretary/accept_existing_patient_modal.html" %}
{% include "secretary/orders_modal.html" %}

<!-- Menu Bar -->
<div class="menu-bar">
    <div class="menu-item">Patient Management
        <div class="submenu">
            <a onclick="openRegisterModal()">‚ûï Register New Patient</a>
            <a onclick="openAcceptModal()">‚úÖ Accept Existing Patient</a>
            <a href="#">üîç Search / View Patients</a>
        </div>
    </div>
    <div class="menu-item">Appointments
        <div class="submenu">
            <a href="#">üìÖ Today‚Äôs Appointments</a>
            <a href="#">‚ûï Book Appointment</a>
            <a href="#">‚úèÔ∏è Reschedule / Cancel</a>
        </div>
    </div>
    <div class="menu-item">Refraction / Reports
        <div class="submenu">
            <a href="#">üëÅ Get Last Refraction</a>
            <a href="#">‚¨ÜÔ∏è Upload Report</a>
            <a href="#">üìÑ View Reports</a>
        </div>
    </div>
    <div class="menu-item">Follow-up / Status
        <div class="submenu">
            <a href="#">‚è≥ Waiting Patients</a>
            <a href="#">‚úÖ Done Patients</a>
            <a href="#">üì¶ Archived</a>
        </div>
    </div>
</div>

<!-- Filter -->
<div class="filter">
    <form id="filter-form" method="GET">
        <label>Start Date:</label>
        <input type="date" name="start_date" value="{{ request.GET.start_date }}">
        <label>End Date:</label>
        <input type="date" name="end_date" value="{{ request.GET.end_date }}">
        <label>Status:</label>
        <select name="status">
            <option value="">All</option>
            <option value="waiting" {% if request.GET.status == 'waiting' %}selected{% endif %}>Waiting</option>
            <option value="accepted" {% if request.GET.status == 'accepted' %}selected{% endif %}>Accepted</option>
            <option value="done" {% if request.GET.status == 'done' %}selected{% endif %}>Done</option>
        </select>
        <button type="submit">Apply Filter</button>
    </form>
</div>

<!-- Patients Table -->
<h2 style="margin-left:20px;">All Patients</h2>
<div id="patients-table">
    {% include "secretary/patients_table.html" %}
</div>


<!-- Toast -->
<div id="successToast" class="toast">‚úÖ Action successful.</div>

<script>


// ================= Register Patient Modal =================
function openRegisterModal() {
  const modal = document.getElementById("registerModal");
  if (modal) {
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden", "false");
  }
}
function closeRegisterModal() {
  const modal = document.getElementById("registerModal");
  if (modal) {
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
  }
}

// ================= Accept Patient Modal =================
function openAcceptModal() {
  const modal = document.getElementById("acceptModal");
  if (modal) {
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden", "false");
  }
}
function closeAcceptModal() {
  const modal = document.getElementById("acceptModal");
  if (modal) {
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
  }
}

// ================= Overlay Click Close =================
window.addEventListener("click", function(e) {
  if (e.target.classList.contains("modal-overlay")) {
    closeRegisterModal();
    closeAcceptModal();
    closeOrdersModal();
  }
});

// ================= Refresh Patients Table =================
function refreshPatientsTable() {
    const params = new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString();
    fetch("{% url 'secretary:patients_table_partial' %}?" + params, { headers: { "X-Requested-With": "XMLHttpRequest" } })
        .then(res => res.text())
        .then(html => { document.getElementById("patients-table").innerHTML = html; })
        .catch(() => {});
}

// ================= Toast =================
function showToast(msg="‚úÖ Action successful.") {
    const t = document.getElementById("successToast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(() => t.style.display = "none", 2500);
}

// ================= Auto-refresh =================
setInterval(refreshPatientsTable, 5000);

// ================= Menu Toggle for Mobile =================
document.querySelectorAll('.menu-bar .menu-item').forEach(item => {
  item.addEventListener('click', function(e) {
    if (e.target.closest('.submenu')) return;
    document.querySelectorAll('.menu-bar .menu-item').forEach(i => {
      if (i !== item) i.classList.remove('active');
    });
    this.classList.toggle('active');
  });
});
document.addEventListener('click', function(e) {
  if (!e.target.closest('.menu-bar')) {
    document.querySelectorAll('.menu-bar .menu-item').forEach(i => i.classList.remove('active'));
  }
});
</script>
{% endblock %}
