{% extends "base.html" %}

{% block title %}Secretary Dashboard{% endblock %}

{% block content %}
<style>
/* ================= Body & Headers ================= */
body { font-family: Arial, sans-serif; margin: 0; background-color: #f5f7fa; }
h1 { color: #2c3e50; margin: 20px; }

/* ================= Top Menu Bar ================= */
.menu-bar {
    display: flex;
    gap: 10px;
    background: #3498db;
    padding: 12px 20px;
    border-radius: 0 0 16px 16px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    position: sticky;
    top: 0;
    z-index: 900;
}

/* Main menu items */
.menu-bar .menu-item {
    position: relative;
    background: white;
    color: #3498db;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.menu-bar .menu-item:hover {
    background: #ecf5ff;
    transform: translateY(-2px);
}

/* Submenu */
.menu-bar .submenu {
    display: none;
    position: absolute;
    top: 110%;
    left: 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    min-width: 200px;
    flex-direction: column;
    z-index: 1000;
}
.menu-bar .submenu a {
    padding: 10px 16px;
    text-decoration: none;
    color: #3498db;
    display: block;
    font-weight: normal;
    transition: background 0.2s;
}
.menu-bar .submenu a:hover { background: #ecf5ff; }

/* Show submenu on hover */
.menu-bar .menu-item:hover .submenu { display: flex; }

/* ================= Filter ================= */
.filter {
    margin: 20px; padding: 10px; background: #fff; border-radius: 8px;
    display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.filter input, .filter select, .filter button {
    padding: 6px 10px; border-radius: 4px; border: 1px solid #ccc;
}
.filter button { background-color: #3498db; color: white; border: none; cursor: pointer; }
.filter button:hover { background-color: #2980b9; }

/* ================= Table ================= */
table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; }
th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
th { background-color: #3498db; color: white; }
tr:nth-child(even) { background-color: #f2f2f2; }
.status-accepted { color: green; font-weight: bold; }
.status-waiting { color: red; font-weight: bold; }
.status-done { color: gray; font-weight: bold; }

/* Buttons inside table */
.accept-button, .remove-button, .done-button, .get-lr-button, .dismiss-button {
    padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;
    transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}
.accept-button { background-color: #28a745; color: white; }
.accept-button:hover { background-color: #218838; transform: translateY(-2px); }
.get-lr-button { background-color: #007bff; color: white; }
.get-lr-button:hover { background-color: #0069d9; transform: translateY(-2px); }
.remove-button { background-color: #e74c3c; color: white; }
.remove-button:hover { background-color: #c0392b; transform: translateY(-2px); }
.done-button { background-color: #2e7d32; color: white; }
.done-button:hover { background-color: #1b5e20; transform: translateY(-2px); }
.dismiss-button { background-color: #f39c12; color: white; }
.dismiss-button:hover { background-color: #d68910; transform: translateY(-2px); }

/* ================= Toast ================= */
.toast {
    position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
    padding: 12px 20px; border-radius: 8px; display: none; z-index: 1000;
}
.toast.error { background: #e74c3c; }
</style>

<h1>Secretary Dashboard</h1>

<!-- üîπ Menu Bar with Submenus -->
<div class="menu-bar">
    <!-- Patient Management -->
    <div class="menu-item">Patient Management
        <div class="submenu">
            <a onclick="openRegisterModal()">‚ûï Register New Patient</a>
            <a onclick="openAcceptModal()">‚úÖ Accept Existing Patient</a>
            <a href="{% url 'secretary:patients_table_partial' %}">üîç Search / View Patients</a>
        </div>
    </div>

    <!-- Appointments -->
    <div class="menu-item">Appointments
        <div class="submenu">
            <a href="">üìÖ Today‚Äôs Appointments</a>
            <a href="">‚ûï Book Appointment</a>
            <a href="">‚úèÔ∏è Reschedule / Cancel</a>
        </div>
    </div>

    <!-- Refraction / Reports -->
    <div class="menu-item">Refraction / Reports
        <div class="submenu">
            <a href="">üëÅ Get Last Refraction</a>
            <a href="">‚¨ÜÔ∏è Upload Report</a>
            <a href="">üìÑ View Reports</a>
        </div>
    </div>

    <!-- Follow-up / Status -->
    <div class="menu-item">Follow-up / Status
        <div class="submenu">
            <a href="">‚è≥ Waiting Patients</a>
            <a href="">‚úÖ Done Patients</a>
            <a href="">üì¶ Dismissed / Archived</a>
        </div>
    </div>

    <!-- Admin -->
    <div class="menu-item">Admin
        <div class="submenu">
            <a href="">üñ® Print Letters</a>
            <a href="">üìä Reports / Stats</a>
        </div>
    </div>
</div>

<!-- üîπ Filter -->
<div class="filter">
    <form id="filter-form" method="GET">
        <label>Start Date:</label>
        <input type="date" name="start_date" value="{{ request.GET.start_date }}">
        <label>End Date:</label>
        <input type="date" name="end_date" value="{{ request.GET.end_date }}">
        <label>Status:</label>
        <select name="status">
            <option value="">All</option>
            <option value="waiting" {% if request.GET.status == 'waiting' %}selected{% endif %}>Waiting</option>
            <option value="accepted" {% if request.GET.status == 'accepted' %}selected{% endif %}>Accepted</option>
            <option value="done" {% if request.GET.status == 'done' %}selected{% endif %}>Done</option>
        </select>
        <label><input type="checkbox" name="keep_dismissed" {% if request.GET.keep_dismissed %}checked{% endif %}> Keep Dismissed Visible</label>
        <button type="submit">Apply Filter</button>
    </form>
</div>

<!-- üîπ Patients Table -->
<h2 style="margin-left:20px;">All Patients</h2>
<div id="patients-table">
    {% include "secretary/patients_table.html" %}
</div>

<!-- üîπ Modals -->
{% include "secretary/register_patient_modal.html" %}
{% include "secretary/accept_existing_patient_modal.html" %}

<!-- üîπ Toast -->
<div id="successToast" class="toast">‚úÖ Action successful.</div>

<script>
// ================= Local Storage Dismiss =================
const dismissedKey = "dismissedPatients";
function getDismissed() { return JSON.parse(localStorage.getItem(dismissedKey) || "[]"); }
function setDismissed(arr) { localStorage.setItem(dismissedKey, JSON.stringify(arr)); }
function removeFromDismissed(patientId) {
    const dismissed = getDismissed().filter(id => id !== patientId.toString());
    setDismissed(dismissed);
}

function toggleDismiss(patientId) {
    const row = document.getElementById(`patient-${patientId}`);
    if (!row) return;
    let dismissed = getDismissed();
    if (dismissed.includes(patientId.toString())) {
        dismissed = dismissed.filter(id => id !== patientId.toString());
        row.style.display = "";
        const btn = row.querySelector(".dismiss-button");
        if (btn) btn.textContent = "Dismiss";
    } else {
        dismissed.push(patientId.toString());
        row.style.display = "none";
    }
    setDismissed(dismissed);
}

function attachDismissHandlers() {
    document.querySelectorAll('.dismiss-button').forEach(button => {
        button.onclick = () => toggleDismiss(button.dataset.patientId);
    });
}

function hideDismissedRows() {
    const dismissed = getDismissed();
    const urlParams = new URLSearchParams(window.location.search);
    const keepDismissed = urlParams.has('keep_dismissed');
    if (!keepDismissed) {
        dismissed.forEach(id => {
            const row = document.getElementById(`patient-${id}`);
            if (row) {
                row.style.display = "none";
                const btn = row.querySelector(".dismiss-button");
                if (btn) btn.textContent = "Restore";
            }
        });
    }
}

// ================= Refresh Patients Table =================
function refreshPatientsTable() {
    const params = new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString();
    fetch("{% url 'secretary:patients_table_partial' %}?" + params, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(res => res.text())
    .then(html => {
        document.getElementById("patients-table").innerHTML = html;
        attachDismissHandlers();
        hideDismissedRows();
    })
    .catch(() => {});
}

// ================= Toast =================
function showToast(msg="‚úÖ Action successful.") {
    const t = document.getElementById("successToast");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(() => t.style.display = "none", 2500);
}

// ================= Modal Controls =================
function openRegisterModal() {
    const modal = document.getElementById("registerModal");
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden", "false");
    const nameInput = document.getElementById("rp_name");
    if (nameInput) nameInput.focus();
}
function closeRegisterModal(newPatientId=null) {
    const modal = document.getElementById("registerModal");
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
    const err = document.getElementById("formError");
    if (err) { err.textContent = ""; err.style.display = "none"; }
    const form = document.getElementById("registerForm");
    if (form) form.reset();
    if (newPatientId) removeFromDismissed(newPatientId);
}

function openAcceptModal() {
    const modal = document.getElementById("acceptModal");
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden", "false");
    const input = document.getElementById("accept_melli");
    if (input) input.focus();
}
function closeAcceptModal(acceptedPatientId=null) {
    const modal = document.getElementById("acceptModal");
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
    const err = document.getElementById("acceptError");
    if (err) { err.textContent = ""; err.style.display = "none"; }
    const form = document.getElementById("acceptForm");
    if (form) form.reset();
    if (acceptedPatientId) removeFromDismissed(acceptedPatientId);
}

// ================= AJAX Form Submissions =================
document.addEventListener("DOMContentLoaded", () => {
    // Register form
    const registerForm = document.getElementById("registerForm");
    if (registerForm) {
        registerForm.onsubmit = (e) => {
            e.preventDefault();
            fetch(registerForm.action, {
                method: "POST",
                body: new FormData(registerForm),
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    closeRegisterModal(data.patient_id);
                    refreshPatientsTable();
                    showToast("‚úÖ Patient registered successfully.");
                } else {
                    const err = document.getElementById("formError");
                    if (err) { err.textContent = data.error || "Registration failed."; err.style.display = "block"; }
                }
            })
            .catch(() => showToast("‚ùå Error registering patient."));
        };
    }

    // Accept form
    const acceptForm = document.getElementById("acceptForm");
    if (acceptForm) {
        acceptForm.onsubmit = (e) => {
            e.preventDefault();
            fetch(acceptForm.action, {
                method: "POST",
                body: new FormData(acceptForm),
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    closeAcceptModal(data.patient_id);
                    refreshPatientsTable();
                    showToast("‚úÖ Patient accepted successfully.");
                } else {
                    const err = document.getElementById("acceptError");
                    if (err) { err.textContent = data.error || "Accept failed."; err.style.display = "block"; }
                }
            })
            .catch(() => showToast("‚ùå Error accepting patient."));
        };
    }
});

// ================= Escape + Click Outside =================
window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
        closeRegisterModal();
        closeAcceptModal();
    }
});
window.addEventListener("click", (event) => {
    if (event.target.id === "registerModal") closeRegisterModal();
    if (event.target.id === "acceptModal") closeAcceptModal();
});

// ================= Initialize =================
attachDismissHandlers();
hideDismissedRows();
setInterval(refreshPatientsTable, 5000);
</script>
{% endblock %}
